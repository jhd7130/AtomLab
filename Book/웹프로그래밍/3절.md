# 3절. Servlet 프로그래밍

이제부터 자바로 웹 프로그래밍을 하는 방법에 대해서 알아볼 겁니다. 자바에서는 웹 브라우저와 웹 서버를 활용하여 좀 더 쉽게 서버 애플리케이션을 만들 수 있는 방법을 제공합니다. 이를 Servlet이라고 부릅니다. 그리고 이 서블릿을 가지고 웹 애플리케이션을 개발하는 것을 서블릿 프로그래밍이라고 명명합니다.

Servlet 프로그래밍에서 가장 중요한 것은 HttpServlet을 상속받는 법을 아는 것이 아니고 Servlet 인터페이스를 정확히 이해하는 것입니다. 이번 절에서는 Servlet 인터페이스를 이해하고 앞으로 나아가 보겠습니다.

# 3.1 CGI 프로그램과 Servlet

**간단히 알고 가는 개념** 

**애플리케이션, 데스크톱 app** : 아이콘을 누르거나 명령창을 통해 로컬에서 직접 실행시키는 것

**웹 애플리케이션** : 웹 브라우저와 웹서버를 통해 간접적으로 실행 시키는 프로그램 
![image](https://user-images.githubusercontent.com/78134917/174471869-938c5ab8-d7e3-4f03-8dcc-5a2ea5695e2c.png)

### #CGI 프로그램

어떤 언어로든 구현이 가능합니다.

- 컴파일 방식(C, C++, JAVA 등) 
컴파일된 기계어로 실행시켜 굉장히 빠름 하지만 소스코드 변경시 재 배포해야하는 번거로움
- 스크립트 방식(Javascript, PHP, Python)
실행 마다 소스코드 검증 및 해석해서 느림, 소스코드 변경시 수정하고 저장하면 끝 편리

## 3.1.1 Servlet

**자바 Servlet과 다른 CGI프로그램과의 차이**

웹 서버와 직접 데이터를 주고 받지 않고 전문 프로그램(Java Servlet Container)로 관리된다.

### Java Container

웹 서버와 Servlet 사이에서 Servlet의 생성과 실행, 소멸 등의 생명 주기를 관리하는 프로그램입니다. 이 서블릿 컨테이너는 웹서버와 CGI규칙에 근거하여 소통을 알아서 해줍니다. 이로써 우리는 더이상 웹 서버와의 통신에 필요한 CGI규칙에 대해 자세히 알 필요는 없습니다. 하지만 서블릿과 서블릭 컨테이너 사이에 필요한 규칙은 알고 있어야합니다.

# 3.2 서블릿 JSP vs Java EE vs WAS

## 3.2.1 JavaEE 기술들

JavaEE 기술사양은 클라우드 어플리케이션과 기업용 애플리케이션 개발에 필요한 여러가지 복합적인 기술들을 모아 놓은 것이고 지속적으로 업그레이드 되고 있습니다. 따라서 하위 기술들 또한 새로운 API를 제공하고 있습니다.

**JavaEE의 장점**

1. 기능 확장이 쉽다.
2. 이기종 간의 이식이 쉽다.
3. 보안성이 높아 신뢰성이 높다
4. 트랜젝션 관리와 분산 기능을 쉽게 구현하는 기술을 제공한다.

이 JavaEE안에 서블릿과 JSP를 기반으로 한 클라이언트.서버 기술을 정의되어 있습니다. 자바로 웹 어플리케이션을 개발한다는 말은 이 기술을 사용하여 애플리케이션을 개발한다는 뜻입니다.

## 3.2.2 WAS의 이해

![image](https://user-images.githubusercontent.com/78134917/174471898-49aacc11-5961-4eee-833c-ba0fd5e547ca.png)

**WAS(web application server)란?**

다시한번 상기하자면 Application Server란 클라이언트 서버 시스템구조(사용자)에서 서버 쪽 애플리케이션의 생성과 실행,소멸을 관리하는 프로그램입니다. 그리고 우리가 배울 WAS는 이전에 봤던 서블릿과 서블릿 컨테이너와 같은 웹 기술을 기반으로 동작되는 애플리케이션 서버를 WAS라고 부릅니다.

정리하면 

Application Server : 클라이언트에서 서버에 있는 애플리케이션을 조작하는 프로그램

Web Application Server : 웹 기술을 기반으로 동작되는 애플리케이션 서버(AS의 확장 개념)

특히 JAVA에서 말하는 WAS는 JavaEE의 기술 사양들을 준수하여 구현한 서버를 지칭합니다. 그래서 'JavaEE이 구현체'라고도 부릅니다.

WAS 상용제품 : 제우수(티멕스 소프트), 웹로직(오라클), 웹스피어(IBM)

### Servlet Container(=Web Container)

JavaEE 기술 중에서 서블릿, JSP 등 웹 관련 부분만 구현한 서버를 지칭한다.

상용 제품 : 톰캣(아파치), Resin(Caucho) 등

※주의 사항

API를 사용할 때는 WAS가 어떤 버전의 JAVAEE를 구현했는지를 확인하고 해당 버전에 맞는 API를 사용해야합니다. 예를들어 고객사에서 이용하는 WAS가 Weblogic10.x라고 한다면 서블릿/jsp를 만들때는 JavaEE 5버전에 맞추어 프로그래밍 해야합니다.

# **웹 프로젝트 준비**

![image](https://user-images.githubusercontent.com/78134917/174471910-d5c15147-5cd7-48b0-bdcd-5fb21f9bd912.png)

## Dynamic Web Project 구조

- src
    
    자바 소스를 위한 폴더
    
    Servlet Class, filter, listener와 여러 property 파일들이 들어있다.
    
- bulid/classes
    
    컴파일된 자바 클래스 파일이 놓이는 폴더
    
- WebContent
    
    HTML,CSS,Javascript, 이미지 파일등이 담긴다. web application을 서버에 배치할 때 이 폴더가 복사됨
    
    - WEB-INF
        
        웹 어플리케이션의 설정과 관련된 파일의 저장 공간(이 폴더에 있는 파일은 클라이언트의 요청이 가능하다. 따라서 이 폴더에 HTML,CSS,Javascript 같은 실 사용 폴더가 포함되면 안됩니다.
        
        - web.xml
            
            web application 배치 설명서(Debyment Descript파일), 웹 어플리케이션 컴포넌트들의 배치 정보들을 이 파일에 작성 서블릿 컨테이너는 클라이언트 요청을 처리할 때 web.xml에 등록된 파일을 참고하여 서블릿 클래스를 찾거나 필터를 실행하는 작업을 수행함
            
        - lib
            
            .jar 파일을 위한 폴더, .jar 파일은 .class파일이나 .properties파일을 두눈 보관소 파일
            .jar이라는 확장자명은 Java Archive에서 따왔고 재밌게도 jar이라는 영단어의 뜻이 '단지'라는 의미를 가지고 있습니다.
            

이제 프로젝트를 생성하고 프로젝트파일을 구성하고 있는 폴더들을 자세히 살펴보았으니 이제는 서블릿을 만들고 테스트 해야하는 순서입니다.

# 3.4 서블릿 만들기

서블릿은 소스파일이므로 project explorer에서 java resource. src에다 servlet들을 보관할 패키지를 만들고 안에 서블릿 파일(java class 파일) 들을 만들어 보겠습니다. 우리가 서블릿 프로그래밍을 사용할때는 처음에 이야기했던 것과 같이 서블릿 인터페이스를 잘 이해하는 것이라고 했습니다.  우리가 만들 모든 서블릿 앱은 Servlet 인터페이스를 implement 를 해야합니다. 그렇다면 Servlet 인터페이스는 어떤 추상 메서드들고 구현되어있을까요?( 인터페이스는 추상메서드의 집합입니다.)

가장 중요한 생성, 실행, 소멸과 두가지 정보 메서드로 구성되어 있습니다

1. init()
서블릿이 클라이언트 요청을 처리하기 전에 준비할 작업이 있을 때 초기화 작업을 진행하는 세팅담당 메서드
2. service()
클라이언트의 요청 마다 실행되는 메서드입니다. Servlet이 실질적으로 고객의 요청에 따라 수행해야할 코드가 위치해 있습니다.
3. destroy()
실행 후 또는 종료해야할 때 초기화 작업이 필요한 것들은 다시 초기화하고 close 해야할 메서드가 있다면 close 해주는 메서드 입니다. 
4. getServletInfo()
ServletConfig 객체 반환(서블릿에 대한 전반적인 정보)
5. getServletConfig()
작성자 또는 구현 버전 정보등 서블릿 외의 필요한 정보들을 반환

이제 인터페이스를 모두 구현하고 나면 web.xml에 있는 파일에 배치 정보를 등록해야합니다. 이 작업이 중요한 이유는 Servlet Container는 배치설명파일(web.xml)에 등록되어 있지 않은 서블릿을 읽지 못합니다.

![image](https://user-images.githubusercontent.com/78134917/174471933-1fff4a66-9c40-43da-9f1d-e21d5b219031.png)


기술 블로그나 API에서 자주 언급되는 내용

패키지명 + 클래스명 = Fully qualified name =QName

### 서블릿의 구동 절차

1. 클라이언트의 요청이 들어온다.
2. 서블릿 컨테이너는 서블릿의 존재여부를 web.xml에서 검색하게 된다.
3. 있다면 그대로 init()등 메서드를 진행하게되고 없다면
해당 요청의 서블릿 클래스를 로딩하고 인스턴스를 준비한다. 그 후 생성자를 실행시키고 인스턴스의 메서드를 실행시킨다.(init()을 통해 사용자 요청에 따른 초기화를 진행
4. service() 메서드 호출로 클라이언트 요청을 처리한다. 그 후 http프로토콜 형식에 맞게 요청에 대한 응답을 제공한다.
5. 시스템 운영자가 서블릿 컨테이너 종료나 웹 어플리케이션 자체를 종료시킨다.
6. 서블릿 컨테이너가 종료되기 전 서블릿이 작업을 마무리 할 수 있도록 생성된 모든 서블릿의 distroy() 메서드를 실행 시키고 종료 

![image](https://user-images.githubusercontent.com/78134917/174471946-11ae1771-78d3-46b1-b286-9ef026d3b83f.png)


※서블릿 인스턴스는 하나만 생성되고 해당 웹 어플리케이션이 종료될때까지 사용된다. 

따라서 인스턴스 변수에 특정 사용자를 위한 데이터를 저장하면 안된다. 또한 클라이언트가 보낸 데이터를 일시적으로 보관하기 위해 서블릿 인스턴스 변수 사용을 안하는 것이 좋다. 

### 웰컴 파일

웹서버에 요청을 할 경우  어떠한 서블릿도 선택하지 않고 디렉토리만 요청 했을때 나오게 되는 디폴트 파일이라고 생각하면 좋겠다.

[http://localhost:9999/web03/Hello](http://localhost:9999/web03/Hello) 대신에

[http://localhost:9999/web03](http://localhost:9999/web03) 까지만 요청 

이런 식으로 서블릿을 요청하지 않게되면 404에러가 생기게되는데 이러한 경우에 메세지를 띄울 수 있게 에러 메세지에 대한 파일을 제공한다고 생각하면된다.( 사용자도 뭐가 문제인지 알아야하기 때문에)

그렇다면 어떤식으로 지정할 수 있을까? 우리가 Dynamic web project를 생성할때 web.xml(배치 설명서)의 생성한다. 이 web.xml파일을 보게되면 welcom-file-list 라는 태그를 발견할 수 있다. 이 태그 안 쪽에 디폴트 파일의 이름을 입력해 놓을 수 있다. 그리고 이렇게 입력해 놓은 파일들은 반드시 WebContent파일 안쪽에 위치해있어야한다.(더 안쪽으로 들어가면 안된다)

# 웹 어플리케이션 배치

우리가 web03이라는 프로젝트를 생성했고 그 프로젝트를 이제 서버에 올려 사용해야하는데 이럴 때 우리는 서버에 우리의 프로젝트를 배치할 필요가 있습니다. 

### 간접 배치

Server 뷰에서 우클릭 Add and Remove, 더블 클릭 후 모듈 창에서 add 

이렇게 Servers 뷰에 등록된 톰캣 서버(실행환경)에 프로젝트를 추가하고 실행하면 이클립스에서 자동으로 웹 애플리케이션을 배치합니다. 이때 배치 폴더는 실제 톰캣 서버가 설치된 폴더가 아니라 워크스페이스 폴더에 있는 WTP(Web Tools Platform) 플러그인이 관리하는 임시폴더 입니다. 우리가 체크한 워크스페이스에 .metadata/.plugin/org.eclipse.wst.server.core/tmp0 가 바로 임시 폴더 입니다.

톰캣의 실행 환경이 여러개일 경우에는 tmp0, tmp1, tmp2 로 폴더가 생겨 납니다. 여기에 모두 임시폴더가 생겨나기 때문에 임시의 의미를 가지고 있는 temporary의 약자 tmp를 사용하게 됩니다.

이렇게 배치하게되면

![image](https://user-images.githubusercontent.com/78134917/174471965-38306d3a-bb53-4c2e-8296-e50ee1e8cc24.png)


이런 식으로 필요한 파일들이 복사되게 됩니다.

## 운영 서버에 배치하기

 우리가 가상 서버에 올릴 프로젝트를 배치 시키고 테스트까지 해봤는데 이제는 실제 운영서버에 프로젝트를 배치시켜보겠습니다. 

우리가 운영서버에 배치를 하기 위해서는 배치할 프로젝트의 WAR파일이 필요합니다. 이 war 파일은

해당 프로젝트 우클릭 → export → WAR클릭 → 프로젝트 명과 저장소 선택 → finish클릭

순서로 진행하게 되면 war파일이 생성됩니다.

이제 이 war 파일을 톰캣이 설치된 파일 안 어딘가에 위치시킬 것입니다. 

javaide/server/apache-tomcat-70.42/webapps 입니다.

근데 저장된 위치는 다들 다름으로 apache-tomcat-70.42가 위치된 곳만 찾으시면 되겠습니다. 

위에 보이는 webapps는 웹 애플리케이션(우리가 만든 프로젝트)를 배치하는 폴더 입니다.
