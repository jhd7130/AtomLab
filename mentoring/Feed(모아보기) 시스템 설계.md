<img width="792" alt="image" src="https://user-images.githubusercontent.com/78134917/170691797-8fc58839-0441-4337-a59a-7217ae3edfe3.png">

**요구사항**   

모아보기라는 기능을 리뉴얼 해야합니다. 내가 구독중인 모든 유저의 글을 시간순으로 정렬해서 볼수 있어야해요. 어떻게 시스템을 구성 하시겠습니까?

**규모**  
내가 구독하고 있는 유저가 10만명
하루에 글이 1000만개씩 올라온다.

**테이블**   
![image](https://user-images.githubusercontent.com/78134917/170660182-d6286835-04b9-41be-805f-9fbd8c548804.png)


- 각각에 피드에 푸쉬하는 방식은 인서트 이벤트가 많이 발생하기 때문에 내가 구독하고 있는 구독자들의 게시물id를 캐시에 저장해 놓고 사용자의 모아보기 피드가 첫 로딩되거나 재로딩될때 해당 캐시의 게시물id를 사용해서 게시물 상세정보를 조회하여 모아보기 피드를 완성하여 반환해줍니다.   
- 많은 사용자의 게시물을 하나의 테이블에서 관리하기는 힘들다고 생각했습니다. 따라서 테이블을 하나의 캐시에 캐싱할 수 있게 파티셔닝을 고려해보았습니다. 아이디의 첫 알파벳을 기준으로 나누어 데이터를 서로 다른 db에 분산시킵니다.( a ~ b : server A , c ~ f : server B) 
- 많은 데이터를 조회할때 조금 더 빠른 조회와 디스크에 접근할 때 생기는 io부하를 줄이기 위해 캐시를 적극 활용하였습니다.

### 사용자 게시물 모아보기 조회 프로세스
1. 사용자가 모아보기 피드를 로딩한다. -> 모아보기 서비스 실행
2. 피드 캐시에서 내가 구독중인 사람들의 (피드id,사용자id) 목록을 조회
3. 해당 목록으로 게시물 캐시에서 게시물의 상세정보를 조회
4. 사용자 id로 사용자 상세정보 조회
5. 조회한 데이터들로 피드 완성, 게시물을 업로드 시간 기준으로 정렬하여 사용자에게 반환  

**캐시저장**  
게시물 업로드 시 --> 게시물 캐시에 저장 --> 게시물 db에 저장  
             --> 팔로워디비에서 내 팔로워 조회 --> 피드캐시에서 내 팔로워들의 게시글id 리스트들에 새 게시물 id 저장(message queue활용하여 저장?)
             
**유저가 글을 삭제한 경우**  
삭제 시 --> 게시글 캐시에서 삭제 --> 게시글 db에서 삭제(active컬럼을 두거나, expiredate를 두고 설정을 변경)  
      --> 팔로워디비에서 내 팔로워 조회 -->  피드캐시에서 내 팔로워들의 게시글id 리스트에서 삭제한 게시글 id 삭제  
    
**팔로워 취소**  
취소 시 --> 내 db에서 나의 팔로워 테이블에서 해당 userid삭제 
      -->  피드캐시에서 해당 userid의 피드 삭제
      
      
      
